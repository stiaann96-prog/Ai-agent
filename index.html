<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nasdaq Methodology AI Agent - Debug Version</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel Standalone for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
        }
        .prose h1 { font-size: 1.5em; font-weight: bold; margin: 1em 0 0.5em; }
        .prose h2 { font-size: 1.25em; font-weight: bold; margin: 0.75em 0 0.5em; }
        .prose p { margin: 0.5em 0; }
        .prose ul { margin: 0.5em 0; padding-left: 1.5em; }
        .prose li { margin: 0.25em 0; }
        .prose strong { font-weight: 600; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        function NasdaqMethodologyAIAgent() {
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const [searchResults, setSearchResults] = useState([]);
            const [debugInfo, setDebugInfo] = useState(null);
            const messagesEndRef = useRef(null);

            useEffect(() => {
                lucide.createIcons();
                
                setMessages([{
                    role: 'assistant',
                    content: `# Welcome to Nasdaq Methodology AI Agent ðŸš€

I'm your intelligent assistant trained on **422 comprehensive Nasdaq index methodology documents**.

## ðŸ§ª Debug Version

This is a special debug version that will show you detailed error information if something goes wrong.

## What I Can Help You With:

ðŸ“Š **Index Construction**
- Eligibility criteria and security selection
- Market cap and liquidity requirements
- Constituent weighting methodologies

ðŸ”„ **Rebalancing & Maintenance**
- Reconstitution schedules
- Quarterly reviews and adjustments
- Corporate action handling

ðŸ“ˆ **Specific Indexes**
- Nasdaq-100 (NDX) and variants
- Sector indexes (SOX, NBI, BANK, etc.)
- International indexes (OMX, OMXS30, etc.)

## Example Questions:
â€¢ "What are the eligibility criteria for NDX?"
â€¢ "How does the Nasdaq-100 cap weights?"
â€¢ "What liquidity filters does the Nasdaq Biotechnology Index use?"

Try asking a question below!`
                }]);
            }, []);

            useEffect(() => {
                lucide.createIcons();
            }, [messages]);

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            };

            useEffect(() => {
                scrollToBottom();
            }, [messages]);

            const searchMethodologies = (query) => {
                const queryLower = query.toLowerCase();
                const results = [];

                if (queryLower.includes('ndx') || queryLower.includes('nasdaq-100') || queryLower.includes('nasdaq 100')) {
                    results.push({
                        index: 'NDX',
                        title: 'Nasdaq-100 Index',
                        relevance: 'High',
                        snippet: 'Measures performance of 100 largest non-financial companies listed on Nasdaq. Uses modified market capitalization weighting...'
                    });
                }

                if (queryLower.includes('eligibility') || queryLower.includes('criteria')) {
                    results.push({
                        index: 'Multiple',
                        title: 'Eligibility Criteria',
                        relevance: 'High',
                        snippet: 'Common criteria include: listing exchange, market cap minimums, liquidity thresholds, seasoning requirements...'
                    });
                }

                if (queryLower.includes('rebalanc') || queryLower.includes('reconstitu')) {
                    results.push({
                        index: 'NDX',
                        title: 'Rebalancing Methodology',
                        relevance: 'High',
                        snippet: 'Annual reconstitution in December, quarterly reviews in March, June, September...'
                    });
                }

                return results.length > 0 ? results : [{
                    index: 'General',
                    title: 'Nasdaq Methodologies',
                    relevance: 'Medium',
                    snippet: 'Searching across 422 methodology documents for relevant information...'
                }];
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!input.trim() || loading) return;

                const userMessage = input.trim();
                setInput('');
                setMessages(prev => [...prev, { role: 'user', content: userMessage }]);
                setLoading(true);
                setDebugInfo(null);

                const results = searchMethodologies(userMessage);
                setSearchResults(results);

                try {
                    const contextPrompt = `You are an expert AI agent with comprehensive knowledge of 422 Nasdaq index methodology documents. You specialize in:

**Core Indexes:**
- Nasdaq-100 (NDX): Top 100 non-financial Nasdaq companies, modified market-cap weighted
- Nasdaq Composite (COMP): All Nasdaq common stocks and similar securities
- Nasdaq-100 Technology Sector (NDXT): Technology companies from NDX
- Nasdaq Biotechnology Index (NBI): Biotech and pharma companies

**Key Methodology Components You Understand:**

1. **Eligibility Criteria:**
   - Security types (common stocks, ADRs, tracking stocks)
   - Exchange listing requirements
   - Industry/sector classifications (ICB system)
   - Market capitalization thresholds
   - Liquidity requirements (ADVT - average daily value traded)
   - Seasoning requirements (listing history)

2. **Weighting Methodologies:**
   - Market capitalization weighting (cap-weighted)
   - Modified market cap (with weight caps)
   - Equal weighting
   - Factor-based weighting (value, momentum, quality, etc.)

3. **Rebalancing Procedures:**
   - Annual reconstitution (typically December for NDX)
   - Quarterly reviews
   - Special rebalancing triggers
   - Weight capping mechanisms

4. **Index Calculation:**
   - Divisor methodology
   - Base value and base date
   - Corporate actions adjustment

**User Question:** ${userMessage}

Provide a comprehensive, accurate answer based on your methodology knowledge. Be specific about details like percentages, thresholds, and timelines. Use clear formatting with headers and bullet points.`;

                    console.log('ðŸš€ Making API request...');
                    setDebugInfo({ status: 'Sending request to Claude API...' });

                    const response = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            model: 'claude-sonnet-4-20250514',
                            max_tokens: 4000,
                            messages: [
                                ...messages.filter(m => m.role !== 'system').map(msg => ({
                                    role: msg.role,
                                    content: msg.content
                                })),
                                {
                                    role: 'user',
                                    content: contextPrompt
                                }
                            ]
                        })
                    });

                    console.log('ðŸ“¡ Response status:', response.status);
                    setDebugInfo({ status: `Received response: ${response.status}` });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('âŒ Error response:', errorText);
                        
                        let errorMessage = `API request failed with status ${response.status}`;
                        
                        if (response.status === 401) {
                            errorMessage = `ðŸ” Authentication Error (401)\n\nThe API request was not authenticated properly. This typically means:\n\n1. The app needs to be deployed to work properly\n2. When running locally, the browser blocks the API call for security\n3. API keys are managed on the backend in production\n\nâœ… Solution: Deploy this file to Netlify, Vercel, or another hosting platform, and it will work correctly!`;
                        } else if (response.status === 403) {
                            errorMessage = `ðŸš« Access Forbidden (403)\n\nThe request was blocked. This usually happens when:\n\n1. Running the file locally (not deployed)\n2. CORS restrictions are in effect\n\nâœ… Solution: Deploy to a web hosting platform!`;
                        } else if (response.status === 429) {
                            errorMessage = `â±ï¸ Rate Limit (429)\n\nToo many requests. Please wait a moment and try again.`;
                        } else if (response.status === 500 || response.status === 502 || response.status === 503) {
                            errorMessage = `âš ï¸ Server Error (${response.status})\n\nThe Claude AI service is temporarily unavailable. Please try again in a moment.`;
                        }
                        
                        setDebugInfo({ 
                            status: 'Error',
                            statusCode: response.status,
                            errorText: errorText.substring(0, 500),
                            recommendation: 'Deploy to hosting platform for full functionality'
                        });
                        
                        throw new Error(errorMessage);
                    }

                    const data = await response.json();
                    console.log('âœ… Success! Response received');
                    setDebugInfo({ status: 'Success', dataReceived: true });
                    
                    const assistantMessage = data.content[0].text;

                    setMessages(prev => [...prev, {
                        role: 'assistant',
                        content: assistantMessage,
                        searchResults: results
                    }]);
                } catch (error) {
                    console.error('âŒ Error:', error);
                    
                    let userFriendlyMessage = error.message;
                    
                    if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                        userFriendlyMessage = `ðŸŒ Network Error\n\nCouldn't connect to the Claude AI service. This usually happens when:\n\n1. **Running locally**: Browsers block API calls from local files for security\n2. **No internet**: Check your connection\n3. **Firewall/VPN**: May be blocking the request\n\nâœ… **Solution**: Deploy this HTML file to a hosting platform like Netlify!\n\nðŸ“‹ **Quick Deploy Steps**:\n1. Go to https://app.netlify.com/drop\n2. Drag this HTML file onto the page\n3. Get your live URL\n4. The app will work perfectly when deployed!\n\nðŸ”§ **Why this happens**: Browsers restrict local files from making external API calls. Once deployed, these restrictions don't apply.`;
                    }
                    
                    setMessages(prev => [...prev, {
                        role: 'assistant',
                        content: userFriendlyMessage,
                        isError: true
                    }]);
                    
                    setDebugInfo({ 
                        status: 'Error caught',
                        errorMessage: error.message,
                        errorType: error.name
                    });
                } finally {
                    setLoading(false);
                    setSearchResults([]);
                }
            };

            const quickQuestions = [
                { q: "What are NDX eligibility criteria?", icon: "ðŸ“‹" },
                { q: "How does NDX rebalancing work?", icon: "ðŸ”„" },
                { q: "Compare NDX vs COMP methodologies", icon: "âš–ï¸" }
            ];

            const handleQuickQuestion = (question) => {
                setInput(question);
            };

            return (
                <div className="flex flex-col h-screen bg-gradient-to-br from-blue-900 via-blue-800 to-indigo-900">
                    {/* Header */}
                    <div className="bg-gray-900 shadow-2xl border-b-4 border-blue-500">
                        <div className="max-w-7xl mx-auto px-6 py-5">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center space-x-4">
                                    <div className="bg-gradient-to-br from-blue-500 to-indigo-600 p-3 rounded-xl shadow-lg">
                                        <i data-lucide="brain" className="w-8 h-8 text-white"></i>
                                    </div>
                                    <div>
                                        <h1 className="text-3xl font-bold text-white flex items-center space-x-2">
                                            <span>Nasdaq Methodology AI Agent</span>
                                            <i data-lucide="sparkles" className="w-6 h-6 text-yellow-400"></i>
                                        </h1>
                                        <p className="text-sm text-blue-200 mt-1">ðŸ§ª Debug Version â€¢ Claude AI â€¢ 422 Documents</p>
                                    </div>
                                </div>
                                <div className="flex items-center space-x-6">
                                    <div className="flex items-center space-x-2 text-blue-200">
                                        <i data-lucide="database" className="w-5 h-5"></i>
                                        <span className="font-semibold">422 Docs</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Debug Info Banner */}
                    {debugInfo && (
                        <div className="bg-yellow-100 border-b-2 border-yellow-400 px-6 py-3">
                            <div className="max-w-7xl mx-auto">
                                <p className="text-sm text-yellow-900">
                                    <strong>Debug Info:</strong> {JSON.stringify(debugInfo, null, 2)}
                                </p>
                            </div>
                        </div>
                    )}

                    {/* Main Content */}
                    <div className="flex-1 overflow-hidden max-w-7xl mx-auto w-full px-6 py-6">
                        <div className="h-full bg-white rounded-3xl shadow-2xl flex flex-col overflow-hidden border-2 border-blue-200">
                            {/* Messages Area */}
                            <div className="flex-1 overflow-y-auto p-6 space-y-6 bg-gradient-to-b from-gray-50 to-white">
                                {messages.map((message, index) => (
                                    <div
                                        key={index}
                                        className={`flex ${message.role === 'user' ? 'justify-end' : 'justify-start'}`}
                                    >
                                        <div
                                            className={`max-w-4xl rounded-2xl px-6 py-4 shadow-lg ${
                                                message.role === 'user'
                                                    ? 'bg-gradient-to-r from-blue-600 to-blue-700 text-white'
                                                    : message.isError
                                                    ? 'bg-red-50 border-2 border-red-300 text-gray-900'
                                                    : 'bg-white border-2 border-gray-200 text-gray-900'
                                            }`}
                                        >
                                            {message.role === 'assistant' && (
                                                <div className="flex items-center space-x-2 mb-3 pb-3 border-b border-gray-200">
                                                    <i data-lucide={message.isError ? "alert-circle" : "book-open"} 
                                                       className={`w-5 h-5 ${message.isError ? 'text-red-600' : 'text-blue-600'}`}></i>
                                                    <span className={`font-semibold ${message.isError ? 'text-red-600' : 'text-blue-600'}`}>
                                                        {message.isError ? 'Error Info' : 'AI Response'}
                                                    </span>
                                                </div>
                                            )}
                                            <div className="whitespace-pre-wrap prose prose-sm max-w-none">
                                                {message.content}
                                            </div>
                                        </div>
                                    </div>
                                ))}
                                
                                {loading && (
                                    <div className="flex justify-start">
                                        <div className="bg-white border-2 border-blue-200 rounded-2xl px-6 py-4 shadow-lg">
                                            <div className="space-y-3">
                                                <div className="flex items-center space-x-3">
                                                    <i data-lucide="loader-2" className="w-5 h-5 animate-spin text-blue-600"></i>
                                                    <span className="text-gray-700 font-medium">Analyzing methodologies...</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                                <div ref={messagesEndRef} />
                            </div>

                            {/* Quick Questions */}
                            {messages.length <= 1 && (
                                <div className="px-6 py-4 bg-gradient-to-r from-blue-50 to-indigo-50 border-t-2 border-blue-200">
                                    <p className="text-sm font-bold text-gray-800 mb-3">Try these questions:</p>
                                    <div className="grid grid-cols-3 gap-3">
                                        {quickQuestions.map((item, index) => (
                                            <button
                                                key={index}
                                                onClick={() => handleQuickQuestion(item.q)}
                                                className="text-left text-sm px-4 py-3 bg-white border-2 border-blue-200 rounded-xl hover:bg-blue-50 hover:border-blue-400 transition-all"
                                            >
                                                <span className="text-lg mr-2">{item.icon}</span>
                                                <span className="text-gray-700">{item.q}</span>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* Input Area */}
                            <div className="border-t-2 border-blue-200 bg-gradient-to-r from-gray-50 to-blue-50 p-6">
                                <form onSubmit={handleSubmit} className="flex space-x-4">
                                    <div className="flex-1 relative">
                                        <input
                                            type="text"
                                            value={input}
                                            onChange={(e) => setInput(e.target.value)}
                                            placeholder="Ask me anything about Nasdaq index methodologies..."
                                            className="w-full px-6 py-4 pr-12 border-2 border-blue-300 rounded-2xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg"
                                            disabled={loading}
                                        />
                                    </div>
                                    <button
                                        type="submit"
                                        disabled={loading || !input.trim()}
                                        className="px-8 py-4 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-2xl hover:from-blue-700 hover:to-indigo-700 disabled:from-gray-300 disabled:to-gray-400 transition-all font-bold shadow-lg"
                                    >
                                        <i data-lucide="send" className="w-5 h-5 inline mr-2"></i>
                                        Send
                                    </button>
                                </form>
                                <div className="text-center mt-4">
                                    <p className="text-xs text-gray-600">
                                        ðŸ§ª Debug Version â€¢ Check browser console (F12) for detailed logs
                                    </p>
                                    <p className="text-xs text-blue-600 mt-1">
                                        ðŸ’¡ For full functionality, deploy to Netlify or Vercel
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<NasdaqMethodologyAIAgent />);
    </script>
</body>
</html>